#textdomain wesnoth-The_Legend_Begins

#define SPECIAL_NOTES_STUN
_ " This unit is able to stun its enemies, disrupting their zones of control."#enddef

#define WEAPON_SPECIAL_STUN
    [damage]
        id=stun
        name= _ "stun"
        description= _ "This attack hits so hard that the defender is dazed and can no longer enforce a zone of control. The effect wears off on the defender's next turn."
        multiply=1
    [/damage]
#enddef

#define STUN_ATTACK_EVENT
[event]
    name=attacker_hits
    first_time_only=no

    [filter_attack]
        special=stun
    [/filter_attack]

    [filter_second]
        [not]
            level=0
        [/not]
    [/filter_second]

    [if]
        [variable]
            name=second_unit.variables.stunned
            boolean_equals=no
        [/variable]
        [then]
            {VARIABLE second_unit.variables.stunned yes}

            [if]
                [variable]
                    name=second_unit.gender
                    equals=female
                [/variable]

                [then]
                    [set_variable]
                        name=tmp_stunned_text
                        value= _ "female^stunned"
                    [/set_variable]
                [/then]

                [else]
                    [set_variable]
                        name=tmp_stunned_text
                        value= _ "stunned"
                    [/set_variable]
                [/else]
            [/if]

            [unstore_unit]
                variable=second_unit
                find_vacant=no
                text=$tmp_stunned_text
                red,green,blue=196,196,128
            [/unstore_unit]

            [object]
                silent=yes
                duration=level

                [filter]
                    x,y=$x2,$y2
                [/filter]

                [effect]
                    apply_to=image_mod
                    replace="CS(50,50,0)"
                [/effect]

                [effect]
                    apply_to=ellipse
                    ellipse="misc/ellipse-nozoc"
                [/effect]

                [effect]
                    apply_to=zoc
                    value=no
                [/effect]
            [/object]

            [clear_variable]
                name=tmp_stunned_text
            [/clear_variable]
        [/then]
    [/if]
[/event]

[event]
    name=turn refresh
    first_time_only=no

    [store_unit]
        [filter]
            side=$side_number
            [filter_wml]
                [variables]
                    stunned=yes
                [/variables]
            [/filter_wml]
        [/filter]
        variable=stunned
    [/store_unit]

    {FOREACH stunned i}
        {VARIABLE stunned[$i].variables.stunned no}

        [unstore_unit]
            variable=stunned[$i]
        [/unstore_unit]

        [object]
            silent=yes
            duration=level

            [filter]
                x,y=$stunned[$i].x,$stunned[$i].y
            [/filter]

            [effect]
                apply_to=image_mod
                replace="NOP()"
            [/effect]

            [effect]
                apply_to=ellipse
                ellipse="misc/ellipse"
            [/effect]

            [effect]
                apply_to=zoc
                value=yes
            [/effect]
        [/object]
    {NEXT i}

    {CLEAR_VARIABLE stunned}
[/event]
#enddef

#define WEAPON_SPECIAL_CLEAVE
    [damage]
      id=cleave
      name= _ "cleave"
      description= _ "Cleave:
On a melee attack, whatever hits the target will also hit enemies in the two hexes that are adjacent to both the attacker and defender, in a crescent moon shape, for 50% of the original damage."
    [/damage]
#enddef

#define SPECIAL_NOTES_CLEAVE
_ " On a melee attack, whatever hits the target will also hit enemies in the two hexes that are adjacent to both the attacker and defender, in a crescent moon shape, for 50% of the original damage."
#enddef

#define CLEAVE_ATTACK_EVENT
    [event]
        name=attacker_hits
        first_time_only=no
        [filter_attack]
            special=cleave
        [/filter_attack]
	{VARIABLE has_poison no}
	{VARIABLE has_slow no}
	[if]
		[variable]
			name=weapon.specials.poison.id
			equals=poison
		[/variable]
		[then]
			{VARIABLE has_poison yes}

		[/then]
	[/if]
	[if]
		[variable]
			name=weapon.specials.slow.id
			equals=slow
		[/variable]
		[then]
			{VARIABLE has_slow yes}

		[/then]
	[/if]
        [harm_unit]
            [filter]
               [filter_adjacent]
                    x,y=$x2,$y2
               [/filter_adjacent]
               [and]
                    [filter_adjacent]
                         x,y=$x1,$y1
                    [/filter_adjacent]
               [/and]
               side=$enemy_sides
            [/filter]
            [filter_second]
               x,y=$x1,$y1
            [/filter_second]
            amount=$($weapon.damage/2)
            damage_type=$weapon.type
            poisoned=$has_poison
            slowed=$has_slow
            fire_event=yes
            experience=no
        [/harm_unit] 
        {CLEAR_VARIABLE has_slow}
        {CLEAR_VARIABLE has_poison}
    [/event]
#enddef

# This is a list of custom TOD schedules

#define CLOUD_DAWN
    [time]
        id=dawn_cloud
        name= _ "Cloudy Dawn"
        image=misc/tod-schedule-cloudy.png~CROP(0,0,125,39)
        red, green, blue=-35, -35, -15
        sound=ambient/morning.ogg
    [/time]
#enddef

#define CLOUD_MORNING
    [time]
        id=morning_cloud
        name= _ "Cloudy Morning"
        image=misc/tod-schedule-cloudy.png~CROP(126,0,125,39)
        lawful_bonus=25
        red, green=-20, -20
    [/time]
#enddef

#define CLOUD_AFTERNOON
    [time]
        id=afternoon_cloud
        name= _ "Cloudy Afternoon"
        image=misc/tod-schedule-cloudy.png~CROP(253,0,125,39)
        lawful_bonus=25
        red, green=-20, -20
    [/time]
#enddef

#define CLOUD_DUSK
    [time]
        id=dusk_cloud
        name= _ "Cloudy Dusk"
        image=misc/tod-schedule-cloudy.png~CROP(0,40,125,39)
        red, green, blue=-15, -35, -35
        sound=ambient/night.ogg
    [/time]
#enddef

#define CLOUD_FIRST_WATCH
    [time]
        id=first_watch_cloud
        name= _ "Cloudy First Watch"
        image=misc/tod-schedule-cloudy.png~CROP(126,40,125,39)
        lawful_bonus=-25
        red, green, blue=-55, -45, -20
    [/time]
#enddef

#define CLOUD_SECOND_WATCH
    [time]
        id=second_watch_cloud
        name= _ "Cloudy Second Watch"
        image=misc/tod-schedule-cloudy.png~CROP(253,40,125,39)
        lawful_bonus=-25
        red, green, blue=-55, -45, -20
    [/time]
#enddef

#define DEFAULT_SCHEDULE_CLOUD_SET
{CLOUD_DAWN}
{CLOUD_MORNING}
{CLOUD_AFTERNOON}
{CLOUD_DUSK}
{CLOUD_FIRST_WATCH}
{CLOUD_SECOND_WATCH}
#enddef

#define TLB_WEATHER_SNOWFALL
    [terrain_graphics]
        map="
1

*"
        [tile]
            pos=1
            set_flag=snow
            no_flag=snow
        [/tile]

        [image]
            position=horizontal
            layer=1000
            name=weather/noweather.png
            [variant]
                tod=dawn,morning,afternoon,dusk,first_watch,second_watch,midnight
                name=weather/snow/snow-1.png:80,weather/snow/snow-2.png:80,weather/snow/snow-3.png:80,weather/snow/snow(4.png:80,weather/snow/snow-5.png:80
            [/variant]
        [/image]
    [/terrain_graphics]
#enddef

#define TLB_WEATHER_HEAVY_RAIN
    [terrain_graphics]
        map="
1
,1
1
,1"
        [tile]
            pos=1
            set_flag=rain
            no_flag=rain
        [/tile]

        [image]
            layer=1000
            name=weather/noweather.png
            [variant]
                tod=dawn_rain,morning_rain,afternoon_rain,dusk_rain,first_watch_rain,second_watch_rain
                name=weather/rain/rain-(1).png:80,weather/rain/rain-(2).png:80,weather/rain/rain-(3).png:80,weather/rain/rain-(4).png:80,weather/rain/rain-(5).png:80
            [/variant]
        [/image]
    [/terrain_graphics]

    [terrain_graphics]
        [tile]
            x=0
            y=0
            set_flag=rain
            no_flag=rain
        [/tile]

        [image]
            layer=1001
            name=weather/noweather.png
            [variant]
                tod=dawn_rain,morning_rain,afternoon_rain,dusk_rain,first_watch_rain,second_watch_rain
                name=weather/rain/rain-(1).png:80,weather/rain/rain-(2).png:80,weather/rain/rain-(3).png:80,weather/rain/rain-(4).png:80,weather/rain/rain-(5).png:80
            [/variant]
        [/image]
    [/terrain_graphics]
#enddef

#define TLB_WEATHER_NORMAL_RAIN
    [terrain_graphics]
        map="
1
1"

        [tile]
            pos=1
            set_flag=rain
            no_flag=rain
        [/tile]

        [image]
            layer=1000
            name=weather/noweather.png
            [variant]
                tod=dawn_rain,morning_rain,afternoon_rain,dusk_rain,first_watch_rain,second_watch_rain
                name=weather/rain/rain-1.png:80,weather/rain/rain-2.png:80,weather/rain/rain-3.png:80,weather/rain/rain-4.png:80,weather/rain/rain-5.png:80,weather/rain/rain-6.png:80,weather/rain/rain-7.png:80,weather/rain/rain-8.png:80
            [/variant]
        [/image]
    [/terrain_graphics]
#enddef

# For a rainy day...

#define RAIN_DAWN
    [time]
        id=dawn_rain
        name= _ "Rainy Dawn"
        image=misc/tod-schedule-rainy.png~CROP(0,0,125,39)
        red, green, blue=-35, -35, -15
        sound=ambient/morning.ogg
    [/time]
#enddef

#define RAIN_MORNING
    [time]
        id=morning_rain
        name= _ "Rainy Morning"
        image=misc/tod-schedule-rainy.png~CROP(126,0,125,39)
        lawful_bonus=25
        red, green=-20, -20
    [/time]
#enddef

#define RAIN_AFTERNOON
    [time]
        id=afternoon_rain
        name= _ "Rainy Afternoon"
        image=misc/tod-schedule-rainy.png~CROP(253,0,125,39)
        lawful_bonus=25
        red, green=-20, -20
    [/time]
#enddef

#define RAIN_DUSK
    [time]
        id=dusk_rain
        name= _ "Rainy Dusk"
        image=misc/tod-schedule-rainy.png~CROP(0,40,125,39)
        red, green, blue=-15, -35, -35
        sound=ambient/night.ogg
    [/time]
#enddef

#define RAIN_FIRST_WATCH
    [time]
        id=first_watch_rain
        name= _ "Rainy First Watch"
        image=misc/tod-schedule-rainy.png~CROP(126,40,125,39)
        lawful_bonus=-25
        red, green, blue=-55, -45, -20
    [/time]
#enddef

#define RAIN_SECOND_WATCH
    [time]
        id=second_watch_rain
        name= _ "Rainy Second Watch"
        image=misc/tod-schedule-rainy.png~CROP(253,40,125,39)
        lawful_bonus=-25
        red, green, blue=-55, -45, -20
    [/time]
#enddef

#define DEFAULT_SCHEDULE_RAIN_SET
{RAIN_DAWN}
{RAIN_MORNING}
{RAIN_AFTERNOON}
{RAIN_DUSK}
{RAIN_FIRST_WATCH}
{RAIN_SECOND_WATCH}
#enddef

#define TLB_LIMIT_ARMY SIDE RACE_NAME TYPES TOTAL VARIABLE
[event]
	name=prestart
	
	[set_variable]
		name={VARIABLE}
		value={TOTAL}
	[/set_variable]
[/event]

[event]
	name=recruit,recall
	first_time_only=no
	
	[filter]
		side={SIDE}
		{RACE_NAME}
	[/filter]

	[set_variable]
		name={VARIABLE}
		sub=1
	[/set_variable]
	
	[if]
		[variable]
			name={VARIABLE}
			equals=0
		[/variable]
		
		[then]
			[print]
				text=_ "No recruits/recalls left for this faction."
				size=28
				red,green,blue=255,0,0
			[/print]
			
			[disallow_recruit]
				side={SIDE}
				type={TYPES}
			[/disallow_recruit]
			
			[store_unit]
				[filter]
					side={SIDE}
					{RACE_NAME}
					[and]
						x,y=recall,recall
					[/and]
				[/filter]
			
				mode=append
				variable=disabled_recalls
				kill=yes
			[/store_unit]
		[/then]
		
		[else]
			[print]
				text=_ "${VARIABLE} recruits/recalls left for this faction."
				size=28
				red,green,blue=0,255,0
			[/print]
		[/else]
	[/if]
	
[/event]

[event]
	name=victory,defeat
	
	[clear_variable]
		name={VARIABLE}
	[/clear_variable]

        {FOREACH disabled_recalls i}
	
            [unstore_unit]
                variable=disabled_recalls[$i]
            [/unstore_unit]
        {NEXT i}
	
	#[unstore_unit]
        # 	variable=disabled_recalls
	#[/unstore_unit]
	
	{CLEAR_VARIABLE disabled_recalls}
[/event]
#enddef

#define DELAY TIME
[delay]
   time="{TIME}"
[/delay]
#enddef

#define TIME_OVER_DEFEAT
[event]
    name="time over"
    [message]
        speaker="narrator"
        image="wesnoth-icon.png"
        message= _ "You have failed to complete the scenario within the defined time limit. Please try again."
    [/message]
[/event]
#enddef

# I limited the strategic options of advancement for the main hero units

#define MAIN_CHARACTERS_ADVANCEMENT
[modify_unit]
    [filter]
        id="Maruful"
    [/filter]
    advances_to="Chevalier"
[/modify_unit]

[modify_unit]
    [filter]
        id="Fairuz"
    [/filter]
    advances_to="Swordsman"
[/modify_unit]

[modify_unit]
    [filter]
        id="Ashhab"
    [/filter]
    advances_to="Javelineer"
[/modify_unit]

[modify_unit]
    [filter]
        id="Mahir"
    [/filter]
    advances_to="Lieutenant"
[/modify_unit]
#enddef

#define HERO_DEATH_EVENTS
[event]
   name="last breath"
   [filter]
      id="Jahin"
   [/filter]
   [message]
      speaker="unit"
      message= _ "I can't die now! I still have much more to do!"
   [/message]
[/event]

[event]
   name=die
   [filter]
       id="Jahin"
   [/filter]
   [endlevel]
       result=defeat
   [/endlevel]
[/event]

[event]
   name="last breath"
   [filter]
      id="Faria"
   [/filter]
   [message]
      speaker="unit"
      message= _ "Farewell.. Jahin!"
   [/message]
   [message]
      speaker="Jahin"
      message="Faria! No!"
   [/message]
[/event]

[event]
   name=die
   [filter]
       id="Faria"
   [/filter]
   [endlevel]
       result=defeat
   [/endlevel]
[/event]

[event]
   name="last breath"
   [filter]
      id="Sadia"
   [/filter]
   [message]
      speaker="unit"
      message= _ "This can't be the end! Or is it?"
   [/message]
[/event]

[event]
   name=die
   [filter]
       id="Sadia"
   [/filter]
   [endlevel]
       result=defeat
   [/endlevel]
[/event]

[event]
   name="last breath"
   [filter]
      id="Krog"
   [/filter]
   [message]
      speaker="unit"
      message= _ "Trolls will not help Jahin without Krog!"
   [/message]
[/event]

[event]
   name=die
   [filter]
       id="Krog"
   [/filter]
   [endlevel]
       result=defeat
   [/endlevel]
[/event]

[event]
   name="last breath"
   [filter]
      id="Maruful"
   [/filter]
   [message]
      speaker="unit"
      message= _ "Argh! I fall, but the humans will be free!"
   [/message]
[/event]

[event]
   name=die
   [filter]
       id="Maruful"
   [/filter]
   [endlevel]
       result=defeat
   [/endlevel]
[/event]

[event]
   name="last breath"
   [filter]
      id="Affan"
   [/filter]
   [message]
      speaker="unit"
      message= _ "Ouch! This is what death feels like?!"
   [/message]
[/event]

[event]
   name=die
   [filter]
       id="Affan"
   [/filter]
   [endlevel]
       result=defeat
   [/endlevel]
[/event]

[event]
   name="last breath"
   [filter]
      id="Fairuz"
   [/filter]
   [message]
      speaker="unit"
      message= _ "No, my friends need me!"
   [/message]
   [message]
      speaker="Sadia"
      message= _ "Screw that, I need you!"
   [/message]
[/event]

[event]
   name=die
   [filter]
       id="Fairuz"
   [/filter]
   [endlevel]
       result=defeat
   [/endlevel]
[/event]

[event]
   name="last breath"
   [filter]
      id="Ashhab"
   [/filter]
   [message]
      speaker="unit"
      message= _ "I deserved better than this!"
   [/message]
[/event]

[event]
   name=die
   [filter]
       id="Ashhab"
   [/filter]
   [endlevel]
       result=defeat
   [/endlevel]
[/event]
#enddef

# Mahir's death event must be separate, as he later switches 'sides'

#define MAHIR_EARLY_DEATH
[event]
   name="last breath"
   [filter]
      id="Mahir"
   [/filter]
   [message]
      speaker="unit"
      message= _ "Argh! I die!"
   [/message]
[/event]

[event]
   name=die
   [filter]
       id="Mahir"
   [/filter]
   [endlevel]
       result=defeat
   [/endlevel]
[/event]
#enddef

#define MORIN_DEATH_EVENT
[event]
   name="last breath"
   [filter]
      id="Morin"
   [/filter]
   [message]
      speaker="Jahin"
      message= _ "We needed that mage in our battles! All is lost now!"
   [/message]
[/event]

[event]
   name=die
   [filter]
       id="Morin"
   [/filter]
   [endlevel]
       result=defeat
   [/endlevel]
[/event]
#enddef

#define SCHEDULE_MIDNIGHT
[time]
   id=midnight
   name= _ "Midnight"
   image=schedule-midnight.png
   lawful_bonus=-30
   red=-45
   green=-35
   blue=-10
[/time]
#enddef

#define ANIMATED_PORTAL X Y
     [terrain_graphics]
        x={X}
        y={Y}
        [tile]
            x=0
            y=0
            [image]
                layer=0
                # wmlscope: start ignoring
                name="../halo/portal-shine1.png:100,../halo/portal-shine2.png:100,../halo/portal-shine3.png:100,../halo/portal-shine4.png:100,../halo/portal-shine5.png:100,../halo/portal-shine6.png:100,../halo/portal-shine7.png:100,../halo/portal-shine8.png:100,../halo/portal-shine7.png:100,../halo/portal-shine6.png:100,../halo/portal-shine5.png:100,../halo/portal-shine4.png:100,../halo/portal-shine3.png:100,../halo/portal-shine2.png:100"
                # wmlscope: stop ignoring
            [/image]
        [/tile]
    [/terrain_graphics]
#enddef

# Macros that are used only in scenario 24

#define ANIMATED_ORC X Y
        [terrain_graphics]
           x={X}
           y={Y}
           [tile]
              x=0
              y=0
              [image]
                 layer=0
                 name="../units/orcs/archer-bow-attack-1.png~RC(magenta>blue):100,../units/orcs/archer-bow-attack-2.png~RC(magenta>blue):100,../units/orcs/archer-bow-attack-3.png~RC(magenta>blue):100,../units/orcs/archer-bow-attack-4.png~RC(magenta>blue):100,../units/orcs/archer-bow.png~RC(magenta>blue):100"
              [/image]
           [/tile]
        [/terrain_graphics]
#enddef

#define RANGED_DAMAGE_MACRO_24

   #[event]
   #   name="new turn"
   #   first_time_only=no
   #   [if]
   #      [have_unit]
   #         side=1
   #         x=33-54
   #         y=5-32
   #      [/have_unit]
   #      [then]
   #         [store_locations]
   #            [filter]
   #               side=1
   #            [/filter]
   #            x=33-54
   #            y=5-32
   #            terrain=G*
   #            variable=vulnerable
   #         [/store_locations]
   #
   #         {FOREACH vulnerable i}
   #            [harm_unit]
   #               [filter]
   #                  x=$vulnerable[$i].x
   #                  y=$vulnerable[$i].y
   #               [/filter]
   #               fire_event=yes
   #               alignment=chaotic
   #               animate=yes
   #               ranged=ranged
   #               amount=8
   #               damage_type=pierce
   #            [/harm_unit]
   #         {NEXT i}
   #
   #         {CLEAR_VARIABLE vulnerable}
   #      [/then]
   #   [/if]
   #[/event]

   [event]
      name="new turn"
      first_time_only=no

      [harm_unit]
         [filter]
            side=1
            [filter_location]
               x=33-54
               y=5-32
               terrain=G*
            [/filter_location]
         [/filter]

         fire_event=yes
         alignment=chaotic
         animate=yes
         amount=8
         damage_type=pierce
         ranged=ranged
      [/harm_unit]
   [/event]

#enddef

#define TLB_TELEPORTATION_RUNE SIDES RUNE X1 Y1 X2 Y2

        # Placing runes
        #[item]
        #    x,y={X1},{Y1}
	#    halo=scenery/rune{RUNE}.png
        #[/item]
        #
        #[item]
        #    x,y={X2},{Y2}
	#    halo=scenery/rune{RUNE}.png
        #[/item]

        {ANIMATED_PORTAL {X1} {Y1}}

	
	# Teleporting out
	[event]
	name=moveto
	first_time_only=no
        [filter]
            x={X1}
            y={Y1}
            side={SIDES}
        [/filter]
        
        [if]
	
			  [then]
				
				[remove_shroud]
					side=$side_number
					x={X2}
					y={Y2}
					radius=1
				[/remove_shroud]
				
				# If there's a unit on the other rune, it swaps places
				[if]
					[have_unit]
						x={X2}
						y={Y2}
					[/have_unit]
					[then]
						{VARIABLE temp_teleportee yes}
						[store_unit]
							[filter]
								x={X2}
								y={Y2}
							[/filter]
							kill=yes
							variable=stored_unit
						[/store_unit]
						{VARIABLE stored_unit.x {X1}}
						{VARIABLE stored_unit.y {Y1}}
					[/then]
				[/if]
				
				[scroll_to]
					x,y={X2},{Y2}
					check_fogged=false
				[/scroll_to]
				
				[item]
					x,y={X2},{Y2}
					halo=scenery/rune{RUNE}-glow.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				[delay]
					time=50
				[/delay]
				[remove_item]
					x,y={X2},{Y2}
				[/remove_item]
				[item]
					x,y={X2},{Y2}
					image=scenery/rune{RUNE}.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				[delay]
					time=50
				[/delay]
				[item]
					x,y={X2},{Y2}
					halo=scenery/rune{RUNE}-glow.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				[delay]
					time=50
				[/delay]
				[remove_item]
					x,y={X2},{Y2}
				[/remove_item]
				[item]
					x,y={X2},{Y2}
					image=scenery/rune{RUNE}.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				[delay]
					time=50
				[/delay]
				[item]
					x,y={X2},{Y2}
					halo=scenery/rune{RUNE}-glow.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				[delay]
					time=50
				[/delay]
				[remove_item]
					x,y={X2},{Y2}
				[/remove_item]
				[item]
					x,y={X2},{Y2}
					image=scenery/rune{RUNE}.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				
				[delay]
					time=50
				[/delay]
				[item]
					x,y={X2},{Y2}
					halo=scenery/rune{RUNE}-glow.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				[delay]
					time=50
				[/delay]
				[remove_item]
					x,y={X2},{Y2}
				[/remove_item]
				[item]
					x,y={X2},{Y2}
					image=scenery/rune{RUNE}.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
			
				[teleport]
				  [filter]
					x={X1}
					y={Y1}
				  [/filter]
				  x={X2}
				  y={Y2}
				[/teleport]
				
				[redraw]
					side=1,2
				[/redraw]
				
				[if]
				
					[then]
						[unstore_unit]
							variable=stored_unit
						[/unstore_unit]
						{CLEAR_VARIABLE stored_unit}
						{CLEAR_VARIABLE temp_teleportee}
					[/then]
				[/if]
				
			[/then]
		[/if]
    [/event]
    
   # Teleporting back
	[event]
	name=moveto
	first_time_only=no
		[filter]
		x={X2}
		y={Y2}
		side={SIDES}
		[/filter]
        
        [if]
		
			#[not]
			#	[have_unit]
			#		x={X1}
			#		y={Y1}
			#	[/have_unit]
			#[/not]
			[then]
				
				[remove_shroud]
					side=$side_number
					x={X1}
					y={Y1}
					radius=1
				[/remove_shroud]
				
				# If there's a unit on the other rune, it swaps places
				[if]
					[have_unit]
						x={X1}
						y={Y1}
					[/have_unit]
					[then]
						{VARIABLE temp_teleportee yes}
						[store_unit]
							[filter]
								x={X1}
								y={Y1}
							[/filter]
							kill=yes
							variable=stored_unit
						[/store_unit]
						{VARIABLE stored_unit.x {X2}}
						{VARIABLE stored_unit.y {Y2}}
					[/then]
				[/if]
				
				[scroll_to]
					x,y={X1},{Y1}
					check_fogged=false
				[/scroll_to]
				
				[item]
					x,y={X1},{Y1}
					halo=scenery/rune{RUNE}-glow.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				[delay]
					time=50
				[/delay]
				[remove_item]
					x,y={X1},{Y1}
				[/remove_item]
				[item]
					x,y={X1},{Y1}
					image=scenery/rune{RUNE}.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				[delay]
					time=50
				[/delay]
				[item]
					x,y={X1},{Y1}
					halo=scenery/rune{RUNE}-glow.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				[delay]
					time=50
				[/delay]
				[remove_item]
					x,y={X1},{Y1}
				[/remove_item]
				[item]
					x,y={X1},{Y1}
					image=scenery/rune{RUNE}.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				[delay]
					time=50
				[/delay]
				[item]
					x,y={X1},{Y1}
					halo=scenery/rune{RUNE}-glow.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				[delay]
					time=50
				[/delay]
				[remove_item]
					x,y={X1},{Y1}
				[/remove_item]
				[item]
					x,y={X1},{Y1}
					image=scenery/rune{RUNE}.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				
				[delay]
					time=50
				[/delay]
				[item]
					x,y={X1},{Y1}
					halo=scenery/rune{RUNE}-glow.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				[delay]
					time=50
				[/delay]
				[remove_item]
					x,y={X1},{Y1}
				[/remove_item]
				[item]
					x,y={X1},{Y1}
					image=scenery/rune{RUNE}.png
				[/item]
				[redraw]
					side=1,2
				[/redraw]
				
				[teleport]
					[filter]
						x={X2}
						y={Y2}
					[/filter]
				x={X1}
				y={Y1}
				[/teleport]
				
				[redraw]
					side=1,2
				[/redraw]
				
				[if]
				
					[then]
						[unstore_unit]
							variable=stored_unit
						[/unstore_unit]
						{CLEAR_VARIABLE stored_unit}
						{CLEAR_VARIABLE temp_teleportee}
					[/then]
				[/if]
				
			[/then]
		[/if]
	[/event]
#enddef

